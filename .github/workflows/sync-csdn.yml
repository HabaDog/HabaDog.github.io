name: Sync CSDN Blog

on:
  schedule:
    # æ¯å‘¨ä¸€å‡Œæ™¨3ç‚¹è‡ªåŠ¨è¿è¡Œ
    - cron: '0 3 * * 1'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'csdn-sync/config.json'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: csdn-sync/package-lock.json
    
    - name: å®‰è£…ä¾èµ–
      run: |
        cd csdn-sync
        npm ci
    
    - name: è¿è¡ŒåŒæ­¥è„šæœ¬
      run: |
        cd csdn-sync
        npm run sync
      env:
        CSDN_USERNAME: ${{ secrets.CSDN_USERNAME }}
    
    - name: æäº¤æ›´æ”¹
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add data/blog.json blog-posts/
        git diff --quiet && git diff --staged --quiet || (
          git commit -m "ğŸ¤– è‡ªåŠ¨åŒæ­¥CSDNåšå®¢ [$(date +'%Y-%m-%d')]"
          git push origin main
        )
